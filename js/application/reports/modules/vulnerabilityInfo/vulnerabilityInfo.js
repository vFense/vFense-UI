define(
    ['jquery', 'underscore', 'backbone', 'crel', 'h5f', 'moment'],
    function ($, _, Backbone, crel, h5f, moment) {
        'use strict';
        var exports = {},
            tabNames = {
                '#main': {
                    name: 'MAIN',
                    keys: [
                        {name: 'supercedes', title: 'Supercedes:', supercedes: [
                            {name: 'supercedes_bulletin_kb', title: 'Supercedes Bulletin KB:'},
                            {name: 'supercedes_bulletin_id', title: 'Supercedes Bulletin ID:'}
                        ]
                        },
                        {name: 'date_posted', title: 'Date Posted:'}
                    ]
                },
                '#bulletin': {
                    name: 'BULLETIN',
                    keys: [
                        {name: 'vulnerability_id', title: 'ID:'},
                        {name: 'details', title: 'Description:'}
                    ]
                },
                '#cveId': {
                    name: 'CVEIDS',
                    keys: [{name: 'cve_ids', title: 'CVE IDs:'}]
                }
            };
        exports.name = 'vulnerabilityInfo';
        exports.models = {
            Main: Backbone.Model.extend({
                defaults: {
                    id: '',
                    defaultTab: '#main'
                }
            })
        };
        exports.views = {
            Main: Backbone.View.extend({
                tagName: 'div',
                className: ['hardwareInfo'].join(' '),
                initialize: function () {
                    if (_.isUndefined(this.model)) {
                        throw new Error('hardwareInfo view requires a hardwareInfo model');
                    }
                    var id = this.model.get('id'),
                        type = this.model.get('type'),
                        that = this;
                    this._currentTab = this.model.get('defaultTab');
                    this.data = new (Backbone.Model.extend({
                        baseUrl: '/api/v1/app/' + type + '/',
                        url: function () {
                            return this.baseUrl + id;
                        }
                    }))();
                    this.listenTo(this.data, 'sync', this.extractVulnerabilityData);
                },
                events: {
                    'click li a[data-toggle=tab]'   : 'changeTab'
                },
                beforeRender: $.noop,
                onRender: $.noop,
                render: function () {
                    if (this.beforeRender !== $.noop) { this.beforeRender(); }

                    var $el = this.$el;

                    if (this.data.url) { this.data.fetch(); }
                    if ($el.children().length === 0) {
                        $el.html(this.layout());
                    }
                    if (this.onRender !== $.noop) { this.onRender(); }
                    return this;
                },
                layout: function () {
                    var fragment = document.createDocumentFragment();
                    fragment.appendChild(
                        crel('div', {class: 'tabbable tabs-left'},
                            crel('ul', {class: 'nav nav-tabs'}),
                            crel('div', {class: 'tab-content'})
                        )
                    );
                    return fragment;
                },
                extractVulnerabilityData: function (model) {
                    if (model.get('http_status') !== 200) {
                        throw new Error('API was not able to fetch data');
                    }

                    var vulnerabilityID = model.get('data').vulnerability_id,
                        type = this.model.get('type');
                    if(model.get('data').vulnerability_id !== '')
                    {
                        var that = this;
                        that.vulnerabilityModel = new (Backbone.Model.extend({
                            baseUrl: '/api/v1/vulnerability/' + type + '/',
                            url: function () {
                                return this.baseUrl + vulnerabilityID;
                            }
                        }))();

                        this.listenTo(this.vulnerabilityModel, 'sync', this.renderTabs);

                        if(this.vulnerabilityModel.url)
                        {
                            this.vulnerabilityModel.fetch();
                        }
                    }
                    else
                    {
                        this.$el.parents('.row-fluid').remove();
                    }
                    return this;
                },
                renderTabs: function(model) {
                    var selected,
                        $navTabs = this.$el.find('.nav-tabs'),
                        fragment = document.createDocumentFragment(),
                        that = this;
                    _.each(_.keys(tabNames), function (tabName) {
                        selected = (tabName === that._currentTab) ? 'active'  : '';
                        fragment.appendChild(
                            crel('li', {class: selected},
                                crel('a', {href: tabName, 'data-toggle': 'tab'}, tabNames[tabName].name))
                        );
                        if (selected) {
                            that.renderTab(tabName);
                        }
                    });
                    $navTabs.empty().append(fragment);
                    return this;
                },
                changeTab: function (event) {
                    event.preventDefault();
                    var href = $(event.currentTarget).attr('href');
                    this.renderTab(href);
                },
                formatDate: function (date) {
                    return date ? moment(date * 1000).format('L') : 'N/A';
                },
                renderTab: function (tab) {
                    var $content = this.$el.find('.tab-content'),
                        $dl = $(crel('table', {class: 'table vulnerability-table'})),
                        data = this.vulnerabilityModel.get('data'),
                        keys = tabNames[tab].keys;
                    $content.empty();
                    if (keys.length) {
                        var that = this;
                        _.each(keys, function (object) {
                            var content = data[object.name];
                            if (_.isUndefined(content)) {
                                return false;
                            } else if (typeof content === 'string') {
                                $dl.append(
                                    crel('tr', crel('th', object.title), crel('td', data[object.name] || 'N/A'))
                                );
                            } else if (content.length) {
                                $dl.append(
                                    crel('tr', crel('th', object.title))
                                );
                                var innerContent;
                                _.each(content, function(innerObj) {
                                    if(object.hasOwnProperty('supercedes'))
                                    {
                                        innerContent = object.supercedes;
                                        _.each(innerContent, function (obj) {
                                            $dl.append(
                                                crel('tr', crel('th', obj.title), crel('td', innerObj[obj.name] || 'N/A'))
                                            );
                                        });
                                    }
                                    else
                                    {
                                        $dl.append(
                                            crel('tr', crel('td', {class: 'cveId'}, crel('a', {href: '#patches/vulnerability/cve/' + innerObj}, innerObj) || 'N/A'))
                                        );
                                    }
                                });
                            } else if(typeof content === "number") {
                                $dl.append(
                                    crel('tr', crel('th', object.title), crel('td', that.formatDate(data[object.name])))
                                );
                            } else {
                                $dl.append(
                                    crel('tr', crel('th', object.title), crel('td', 'No data to display'))
                                );
                            }
                        });
                    }
                    $content.append($dl);
                }
            })
        };
        return exports;
    }
);
